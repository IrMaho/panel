# ======================================================================
#  ğŸš€ Ú¯Ø±Ø¯Ø´ Ú©Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒØŒ Ú©Ø§Ù…Ù„ Ùˆ Ø¬Ø§Ù…Ø¹ Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ÙÙ„Ø§ØªØ±
#  Ù…Ø¹Ù…Ø§Ø±ÛŒ Ú†Ù†Ø¯Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒØŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡
# ======================================================================
name: ğŸ¦ Build, Deploy & Optimize Flutter App

on:
  push:
    branches: [ main, master ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'ios/**'
      - 'linux/**'
      - 'windows/**'
      - 'web/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.3' # <--- Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØ¯Ø§Ø± (Ø´Ø§Ù…Ù„ Dart 3.5)
  JAVA_VERSION: '17'
  PUBLIC_REPO_PATH: ShoghShahadat/doaye_komeyl
  PUBLIC_REPO_NAME: doaye_komeyl
  PUBLIC_REPO_OWNER: ShoghShahadat

jobs:
  # ======================================================================
  #  Job 1: âš™ï¸ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ø­ÛŒØ·
  # ======================================================================
  setup-environment:
    name: 'âš™ï¸ 1. Setup Environment'
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
      - name: 'ğŸ¦ Setup Flutter SDK & Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'â„¹ï¸ Display Flutter Version'
        run: flutter --version

  # ======================================================================
  #  Job 2: ğŸ¤– Ø¨ÛŒÙ„Ø¯ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ (Ú©Ø§Ù…Ù„ Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡)
  # ======================================================================
  build-android:
    name: 'ğŸ¤– 2. Build Android'
    needs: setup-environment
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
      
      # --- FIX START: Ø§ØµÙ„Ø§Ø­ Ø®Ø·Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ Ù†Ø³Ø®Ù‡ Ø¯Ø± pubspec.yaml ---
      - name: 'ğŸ”§ Auto-Fix pubspec.yaml SDK Constraint'
        run: |
          # Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø®Ø·Ø§ÛŒ Ø±Ø§ÛŒØ¬ ØªØ§ÛŒÙ¾ÛŒ (Ù†ÙˆØ´ØªÙ† Ù†Ø³Ø®Ù‡ ÙÙ„Ø§ØªØ± Ø¨Ø¬Ø§ÛŒ Ø¯Ø§Ø±Øª) Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
          sed -i 's/\^3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
          sed -i 's/>=3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
          echo "âœ… Pubspec constraint patched if necessary."
      # --- FIX END ---

      - name: 'ğŸ¦ Restore Flutter from Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'â˜• Setup Java (JDK)'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      - name: 'ğŸ—„ï¸ Cache Gradle Dependencies'
        id: cache-gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: 'ğŸ—„ï¸ Cache Flutter Pub Dependencies'
        id: cache-pub
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: 'ğŸ—„ï¸ Cache Compiler Workbench (.dart_tool)'
        uses: actions/cache@v4
        with:
          path: .dart_tool
          key: ${{ runner.os }}-dart-workbench-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-dart-workbench-
      - name: 'ğŸ”‘ Setup Android Keystore'
        run: |
          echo "::group::ğŸ”‘ Setting up Android keystore"
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > android/app/Releasekey.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=app/Releasekey.jks" >> android/key.properties
          echo "::endgroup::"
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      - name: 'ğŸ“Š Reporting & Getting Dependencies'
        run: |
          echo "::group::ğŸ“ˆ Cache Status Report"
          if [ "${{ steps.cache-gradle.outputs.cache-hit }}" = "true" ]; then
              echo "âœ… Gradle cache restored successfully."
          else
              echo "âš ï¸ Gradle cache not found. Will be created for the next run."
          fi
          if [ "${{ steps.cache-pub.outputs.cache-hit }}" = "true" ]; then
              echo "âœ… Pub cache restored successfully."
          else
              echo "âš ï¸ Pub cache not found. Will be created for the next run."
          fi
          echo "::endgroup::"
          echo "::group::ğŸ“¦ Installing Flutter dependencies (flutter pub get)"
          flutter pub get
          echo "::endgroup::"
      - name: 'ğŸ› ï¸ Build Android APKs (Split per ABI)'
        run: |
          echo "::group::ğŸš€ Building Android APK (flutter build apk)"
          flutter build apk --split-per-abi --release
          echo "::endgroup::"
      - name: 'â¬†ï¸ Upload Android APK (arm64-v8a)'
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-arm64-v8a
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
      - name: 'â¬†ï¸ Upload Android APK (armeabi-v7a)'
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-armeabi-v7a
          path: build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
      - name: 'â¬†ï¸ Upload Android APK (x86_64)'
        uses: actions/upload-artifact@v4
        with:
          name: release-apk-x86_64
          path: build/app/outputs/flutter-apk/app-x86_64-release.apk
      - name: 'â¬†ï¸ Upload All Android APKs (Combined Zip)'
        uses: actions/upload-artifact@v4
        with:
          name: release-apks-combined
          path: build/app/outputs/flutter-apk/

  # ======================================================================
  #  Job 3: ğŸ Ø¨ÛŒÙ„Ø¯ Ø¢ÛŒâ€ŒØ§ÙˆØ§Ø³
  # ======================================================================
  build-ios:
    name: 'ğŸ 3. Build iOS'
    needs: setup-environment
    runs-on: macos-latest
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
      
      # --- FIX START: Ø§ØµÙ„Ø§Ø­ Ø®Ø·Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ø¨Ø±Ø§ÛŒ macOS (ØªÙØ§ÙˆØª Ø¯Ø³ØªÙˆØ± sed) ---
      - name: 'ğŸ”§ Auto-Fix pubspec.yaml SDK Constraint'
        run: |
          sed -i '' 's/\^3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
          sed -i '' 's/>=3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
      # --- FIX END ---

      - name: 'ğŸ¦ Restore Flutter from Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'ğŸ—„ï¸ Cache Flutter Pub Dependencies'
        uses: actions/cache@v4
        with:
          path: ${{ env.PUB_CACHE }}
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      - name: 'ğŸ”‘ Install Apple Certificate and Provisioning Profile'
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "" $KEYCHAIN_PATH
          echo "${{ secrets.P12_CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k $KEYCHAIN_PATH -P "${{ secrets.P12_CERTIFICATE_PASSWORD }}" -A
          rm certificate.p12
          security default-keychain -s $KEYCHAIN_PATH
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > $PP_PATH
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp $PP_PATH "$HOME/Library/MobileDevice/Provisioning Profiles/"
      - name: 'âš™ï¸ Get Dependencies'
        run: flutter pub get
      - name: 'ğŸ› ï¸ Build iOS IPA'
        run: flutter build ipa --release
      - name: 'â¬†ï¸ Upload iOS IPA Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: release-ios-ipa
          path: build/ios/ipa/*.ipa

  # ======================================================================
  #  Job 4: ğŸªŸ Ø¨ÛŒÙ„Ø¯ ÙˆÛŒÙ†Ø¯ÙˆØ²
  # ======================================================================
  build-windows:
    name: 'ğŸªŸ 4. Build Windows'
    needs: setup-environment
    runs-on: windows-latest
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
      
      # --- FIX START: Ø§ØµÙ„Ø§Ø­ Ø®Ø·Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ø¨Ø±Ø§ÛŒ Windows PowerShell ---
      - name: 'ğŸ”§ Auto-Fix pubspec.yaml SDK Constraint'
        shell: powershell
        run: |
          if (Test-Path pubspec.yaml) {
            (Get-Content pubspec.yaml) -replace '\^3.10.0', '>=3.0.0 <4.0.0' | Set-Content pubspec.yaml
            (Get-Content pubspec.yaml) -replace '>=3.10.0', '>=3.0.0 <4.0.0' | Set-Content pubspec.yaml
          }
      # --- FIX END ---

      - name: 'ğŸ¦ Restore Flutter from Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'âš™ï¸ Install and start sccache'
        uses: mozilla/sccache-action@v0.0.5
      - name: 'ğŸ—„ï¸ Cache Windows-Specific Dependencies (sccache)'
        uses: actions/cache@v4
        with:
          path: ~\.cache\sccache
          key: ${{ runner.os }}-sccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-sccache-
      - name: 'ğŸ”§ Configure build to use sccache'
        shell: powershell
        run: |
          echo "CMAKE_C_COMPILER_LAUNCHER=sccache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "CMAKE_CXX_COMPILER_LAUNCHER=sccache" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: 'âš™ï¸ Enable Windows & Get Dependencies'
        run: |
          flutter config --enable-windows-desktop
          flutter pub get
      - name: 'ğŸ› ï¸ Build Windows Executable'
        run: flutter build windows --release
      - name: 'ğŸ“Š Show sccache statistics'
        run: sccache -s
      - name: 'â¬†ï¸ Upload Windows Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: build/windows/x64/runner/Release/

  # ======================================================================
  #  Job 5: ğŸ§ Ø¨ÛŒÙ„Ø¯ Ù„ÛŒÙ†ÙˆÚ©Ø³
  # ======================================================================
  build-linux:
    name: 'ğŸ§ 5. Build Linux'
    needs: setup-environment
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4
      
      # --- FIX START ---
      - name: 'ğŸ”§ Auto-Fix pubspec.yaml SDK Constraint'
        run: |
          sed -i 's/\^3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
          sed -i 's/>=3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
      # --- FIX END ---

      - name: 'ğŸ¦ Restore Flutter from Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'ğŸ—„ï¸ Cache Build Tools (Pub, .dart_tool)'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-dart-workbench-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-dart-workbench-
      - name: 'ğŸ”§ Install Linux Build Dependencies'
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
      - name: 'âš™ï¸ Enable Linux & Get Dependencies'
        run: |
          flutter config --enable-linux-desktop
          flutter pub get
      - name: 'ğŸ› ï¸ Build Linux Executable'
        run: flutter build linux --release
      - name: 'â¬†ï¸ Upload Linux Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: build/linux/x64/release/bundle/
      
  # ======================================================================
  #  Job 6: ğŸŒ Ø¨ÛŒÙ„Ø¯ ÙˆØ¨
  # ======================================================================
  build-web:
    name: 'ğŸŒ 6. Build Web'
    needs: setup-environment
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      # --- FIX START ---
      - name: 'ğŸ”§ Auto-Fix pubspec.yaml SDK Constraint'
        run: |
          sed -i 's/\^3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
          sed -i 's/>=3.10.0/>=3.0.0 <4.0.0/g' pubspec.yaml || true
      # --- FIX END ---

      - name: 'ğŸ¦ Restore Flutter from Cache'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: 'ğŸ—„ï¸ Cache Compiler Workbench (.dart_tool) and Pub'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
          key: ${{ runner.os }}-dart-workbench-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-dart-workbench-
      - name: 'ğŸ—„ï¸ Cache Final Web Build Output'
        id: cache-web-build
        uses: actions/cache@v4
        with:
          path: build/web
          key: ${{ runner.os }}-web-build-${{ hashFiles('lib/**', 'web/**', 'pubspec.yaml', 'pubspec.lock') }}
      - name: 'âš™ï¸ Get Dependencies'
        run: flutter pub get
      - name: 'ğŸ› ï¸ Build Web if final output cache missed'
        if: steps.cache-web-build.outputs.cache-hit != 'true'
        run: flutter build web --release --base-href "/${{ env.PUBLIC_REPO_NAME }}/"
      - name: 'â¬†ï¸ Upload Web Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: release-web
          path: build/web/
      
  # ======================================================================
  #  Job 7: ğŸš€ Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙˆØ¨
  # ======================================================================
  deploy-web:
    name: 'ğŸš€ 7. Deploy Web'
    needs: build-web
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 'ğŸ“¥ Download Web Artifact'
        uses: actions/download-artifact@v4
        with:
          name: release-web
          path: .
      - name: 'ğŸš€ Deploy to Public GitHub Pages'
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PAT_FOR_PUBLIC_REPO }}
          external_repository: ${{ env.PUBLIC_REPO_PATH }}
          publish_branch: gh-pages
          publish_dir: .
      - name: 'ğŸ“ Generate Deployment Link & Button'
        run: |
          PREVIEW_URL="https://${{ env.PUBLIC_REPO_OWNER }}.github.io/${{ env.PUBLIC_REPO_NAME }}/"
          echo "# ğŸš€ Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙˆØ¨ Ø¯Ø± ÙˆÛŒØªØ±ÛŒÙ† Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† ÙˆØ¨ Ø´Ù…Ø§ Ø§Ú©Ù†ÙˆÙ† Ø¯Ø± GitHub Pages ÙØ¹Ø§Ù„ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ² Ø§Ø³Øª." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø²Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø²ÛŒØ¨Ø§ Ùˆ Ø¯Ø±Ø®Ø´Ø§Ù† Ø²ÛŒØ± Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<a href=\"$PREVIEW_URL\" target=\"_blank\"><img src=\"https://img.shields.io/badge/Ù…Ø´Ø§Ù‡Ø¯Ù‡_Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´_Ø²Ù†Ø¯Ù‡-4CAF50?style=for-the-badge&logo=rocket&logoColor=white\" alt=\"Live Preview\"></a>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…:** [$PREVIEW_URL]($PREVIEW_URL)" >> $GITHUB_STEP_SUMMARY
